{% load static %}
{% load carts_tags %}
{% user_carts request as carts %}<!--запускается шаблонный тэг, берет значение user_carts и записывается в переменную carts-->

<p>My orders</p>
{% for cart in carts %}
<div class="shop-page-card shop-page-card-cont" data-cart-id="{{ cart.id }}">
    <div class="shop-page-card-cont-left">
        <a href="{% url 'product' cart.product.slug %}" title="Go to description">
            <img src="{{ cart.product.image.url }}" alt="img" >
        </a>
    </div>
    <div class="shop-page-card-cont-middle">
        <a class="post-title" href="{% url 'product' cart.product.slug %}" title="{{cart.product.name}}">{{ cart.product.name|truncatechars:35 }}      
        </a><!--оберание оборажения более чем 20ти символов на странице-->
        <p>{{ cart.product.sell_price }}$</p>
        <strong>Totall {{ cart.products_price }}$</strong><!--обращаемся в методу, написанному в carts/Carts.Models-->
    </div>
    <div class="shop-page-card-cont-right">
        <button type="button" class="change-quantity" data-cart-id="{{ cart.id }}" 
        data-change-url="{% url 'cart-change' product_slug=cart.product.slug %}" data-action="decrease">{% csrf_token %}-</button>
        <p class="cart-quantity" data-cart-id="{{ cart.id }}">WTB {{ cart.quantity }} pieces</p>
        <button type="button" class="change-quantity" data-cart-id="{{ cart.id }}" 
        data-change-url="{% url 'cart-change' product_slug=cart.product.slug %}" data-action="increase">{% csrf_token %}+</button> 
        <button type="button" class="remove-cart-item" data-cart-id="{{ cart.id }}" data-remove-url="{% url 'cart-remove' cart.id %}">{% csrf_token %}
            <img src="{% static 'image/icons/trash.png' %}" alt="img" width="16" height="16">
        </button>
    </div>
</div>
{% endfor %}
<strong id="cart-quantity">{{ carts.totall_quantity }} goods for</strong><strong id="cart-price"> totall {{ carts.totall_price }} $</strong>
{% if carts %}<!--показываем кнопку Заказать только если есть корзины пользователя-->
<strong><a href="#">Place an order!</a></strong>
{% endif %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
    // Изменение количества товара
    $('.change-quantity').on('click', function() {
        var cartId = $(this).data('cart-id');
        var changeUrl = $(this).data('change-url');
        var action = $(this).data('action');
        var button = $(this); // Сохраняем ссылку на кнопку

        $.ajax({
            url: changeUrl,
            type: 'POST',
            data: {
                'action': action,
                'cart_id': cartId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Обновить количество на странице
                // Например, если response содержит новое количество
                var cartId = button.data('cart-id'); // Получаем cart_id из сохраненной кнопки
                $('p.cart-quantity[data-cart-id="' + cartId + '"]').text('WTB ' + response.new_quantity + ' pieces');     
                // $('p:contains("WTB")').text('WTB ' + response.new_quantity + ' pieces');
                updateCartSummary(response);
            },
            error: function(xhr) {
                console.error(xhr.responseText);
            }
        });
    });
    
    // Удаление товара из корзины
    $('.remove-cart-item').on('click', function() {
        var cartId = $(this).data('cart-id');
        var removeUrl = $(this).data('remove-url');

        $.ajax({
            url: removeUrl,
            type: 'POST',
            data: {
                'cart_id': cartId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Удалить элемент из DOM или обновить корзину
                $('div.shop-page-card[data-cart-id="' + cartId + '"]').remove();
            },
            error: function(xhr) {
                console.error(xhr.responseText);
            }
        });
    });

    function updateCartSummary(response) {
        // Предполагаем, что сервер возвращает обновленные данные о сумме и количестве
        $('#cart-quantity').text(response.total_quantity + ' goods for');
        $('#cart-price').text('total ' + response.total_price + ' $');
    }
});
</script>